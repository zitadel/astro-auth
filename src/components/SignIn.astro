---
import type { HTMLAttributes } from 'astro/types';
import type {
  BuiltInProviders,
  SignInOptions,
  SignInAuthorizationParams,
} from '../types';

/**
 * Props for the SignIn component.
 *
 * Extends standard HTML button attributes with authentication-specific
 * options for configuring the sign-in behavior.
 */
interface Props extends HTMLAttributes<'button'> {
  /**
   * The authentication provider to sign in with.
   *
   * Can be a built-in provider (e.g., 'google', 'github') or a custom
   * provider identifier.
   */
  provider?: BuiltInProviders | string;

  /**
   * Additional options to pass to the signIn function.
   *
   * These options control the sign-in behavior, such as redirect URLs
   * and callback handling.
   */
  options?: SignInOptions;

  /**
   * Authorization parameters to pass to the authentication provider.
   *
   * These are provider-specific parameters that customize the
   * authentication flow.
   */
  authParams?: SignInAuthorizationParams;
}

// Generate a unique identifier for this component instance to avoid
// conflicts when multiple SignIn buttons are present on the same page
const key = Math.random().toString(36).slice(2, 11);

// noinspection JSUnusedGlobalSymbols
const { provider, options, authParams, ...attrs } = Astro.props;
attrs.class = `signin-button ${attrs.class ?? ''}`;
---

<button
  {...attrs}
  data-signin-key={key}
  data-signin-provider={provider}
  data-signin-options={options ? JSON.stringify(options) : undefined}
  data-signin-auth-params={authParams ? JSON.stringify(authParams) : undefined}
>
  <slot />
</button>

<script>
  import { signIn } from '../client';

  // Attach event listeners to all sign-in buttons
  document.querySelectorAll('[data-signin-key]').forEach((button) => {
    if (button instanceof HTMLElement && !button.dataset.signinInitialized) {
      button.dataset.signinInitialized = 'true';

      button.addEventListener('click', () => {
        const provider = button.dataset.signinProvider;
        const options = button.dataset.signinOptions
          ? JSON.parse(button.dataset.signinOptions)
          : undefined;
        const authParams = button.dataset.signinAuthParams
          ? JSON.parse(button.dataset.signinAuthParams)
          : undefined;

        signIn(provider, options, authParams);
      });
    }
  });
</script>
